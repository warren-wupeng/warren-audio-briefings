<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000">
<title>沈知意 | Zoey</title>
<link rel="manifest" href="manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,'PingFang SC','Helvetica Neue','Microsoft YaHei',sans-serif;
  background:#000;color:#fff;
  min-height:100vh;min-height:100dvh;
  -webkit-tap-highlight-color:transparent;
  overflow-x:hidden;
}

/* Full-screen background photo */
.bg-photo{
  position:fixed;top:0;left:0;right:0;
  height:100vh;height:100dvh;
  background-size:cover;background-position:center top;
  z-index:0;
}
.bg-photo::after{
  content:'';position:absolute;bottom:0;left:0;right:0;
  height:55%;
  background:linear-gradient(to top,rgba(0,0,0,.85) 0%,rgba(0,0,0,.5) 40%,transparent 100%);
}

/* Header — transparent, over photo */
.header{
  position:fixed;top:0;left:0;right:0;z-index:200;
  padding:env(safe-area-inset-top) 0 0;
}
.header-inner{
  max-width:480px;margin:0 auto;
  display:flex;align-items:center;gap:10px;
  height:52px;padding:0 16px;
}
.header-avatar{
  width:36px;height:36px;border-radius:50%;overflow:hidden;
  border:2px solid rgba(255,255,255,.3);flex-shrink:0;
}
.header-avatar img{width:100%;height:100%;object-fit:cover}
.header-info{flex:1}
.header-name{font-size:1rem;font-weight:600;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.5)}
.header-tag{font-size:.68rem;color:rgba(255,255,255,.6)}

/* Scroll container — messages in lower portion */
.scroll-wrap{
  position:relative;z-index:1;
  min-height:100vh;min-height:100dvh;
  display:flex;flex-direction:column;
  justify-content:flex-end;
}

/* Spacer pushes messages to bottom half */
.photo-spacer{
  flex-shrink:0;
  height:48vh;
  pointer-events:none;
}

.chat-area{
  max-width:480px;width:100%;margin:0 auto;
  padding:0 14px 150px;
}

/* Time divider */
.time-divider{text-align:center;padding:12px 0 8px}
.time-divider span{
  display:inline-block;padding:3px 10px;border-radius:4px;
  background:rgba(0,0,0,.3);backdrop-filter:blur(8px);
  font-size:.7rem;color:rgba(255,255,255,.6);
}

/* Message bubble — no avatar */
.msg{margin-bottom:10px}
.bubble{
  display:inline-block;max-width:88%;
  padding:10px 14px;
  border-radius:16px;
  background:rgba(255,255,255,.12);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,.08);
  font-size:.88rem;line-height:1.55;color:rgba(255,255,255,.92);
  word-break:break-word;
}

/* Audio card */
.audio-card{cursor:pointer;transition:all .15s;min-width:210px}
.audio-card:active{opacity:.7}

.ac-header{display:flex;align-items:center;gap:10px}
.ac-play{
  flex-shrink:0;width:38px;height:38px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.2);color:#fff;
  transition:all .15s;
}
.ac-play:active{transform:scale(.9)}
.ac-play.playing{
  background:rgba(255,255,255,.35);
  animation:glow 1.5s infinite;
}
@keyframes glow{
  0%,100%{box-shadow:0 0 8px rgba(255,255,255,.1)}
  50%{box-shadow:0 0 16px rgba(255,255,255,.3)}
}

.ac-info{flex:1;min-width:0}
.ac-title{
  font-size:.88rem;font-weight:500;color:#fff;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.ac-meta{font-size:.7rem;color:rgba(255,255,255,.5);margin-top:1px}

.ac-wave{display:flex;align-items:center;gap:2px;height:18px;margin-top:6px}
.ac-wave .bar{width:2.5px;border-radius:2px;background:rgba(255,255,255,.2);height:4px}
.ac-wave.active .bar{animation:wave .6s ease-in-out infinite alternate;background:rgba(255,255,255,.7)}
.ac-wave.active .bar:nth-child(1){animation-delay:0s}
.ac-wave.active .bar:nth-child(2){animation-delay:.08s}
.ac-wave.active .bar:nth-child(3){animation-delay:.16s}
.ac-wave.active .bar:nth-child(4){animation-delay:.12s}
.ac-wave.active .bar:nth-child(5){animation-delay:.2s}
.ac-wave.active .bar:nth-child(6){animation-delay:.04s}
.ac-wave.active .bar:nth-child(7){animation-delay:.18s}
.ac-wave.active .bar:nth-child(8){animation-delay:.1s}
@keyframes wave{0%{height:4px}100%{height:18px}}

/* Player bar */
.player-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:rgba(20,20,20,.85);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid rgba(255,255,255,.06);
  padding:10px 16px calc(10px + env(safe-area-inset-bottom));
  transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);
}
.player-bar.visible{transform:translateY(0)}

.p-top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.p-avatar{width:34px;height:34px;border-radius:8px;overflow:hidden;flex-shrink:0}
.p-avatar img{width:100%;height:100%;object-fit:cover}
.p-info{flex:1;min-width:0}
.p-info .t{font-size:.8rem;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.p-info .m{font-size:.68rem;color:rgba(255,255,255,.4)}

.prog-wrap{width:100%;height:24px;display:flex;align-items:center;cursor:pointer;touch-action:none}
.prog-bg{width:100%;height:2.5px;background:rgba(255,255,255,.12);border-radius:2px;position:relative}
.prog-fill{height:100%;background:#fff;border-radius:2px;width:0%;position:relative;transition:none}
.prog-fill::after{
  content:'';position:absolute;right:-5px;top:50%;transform:translateY(-50%);
  width:10px;height:10px;background:#fff;border-radius:50%;
}
.time-row{display:flex;justify-content:space-between;font-size:.66rem;color:rgba(255,255,255,.35);margin:2px 0 8px}

.controls{display:flex;align-items:center;justify-content:center;gap:14px}
.ctrl-btn{
  background:none;border:none;color:rgba(255,255,255,.6);cursor:pointer;
  width:40px;height:40px;display:flex;align-items:center;justify-content:center;
  border-radius:50%;transition:all .15s;
}
.ctrl-btn:active{background:rgba(255,255,255,.1)}
.ctrl-btn.play{
  width:48px;height:48px;background:#fff;color:#000;border-radius:50%;
}
.ctrl-btn.play:active{background:rgba(255,255,255,.8)}
.speed-btn{
  font-size:.74rem;font-weight:700;min-width:40px;
  padding:5px 8px;background:rgba(255,255,255,.1);border:none;
  color:rgba(255,255,255,.7);border-radius:8px;cursor:pointer;
}

.loading{text-align:center;padding:40px;color:rgba(255,255,255,.4);font-size:.85rem}

/* Playing mode — collapse to show only 2 messages */
.chat-area.playing-mode .msg{display:none}
.chat-area.playing-mode .msg.vis{display:block}
.chat-area.playing-mode .time-divider{display:none}
.chat-area.playing-mode .time-divider.vis{display:block}
.collapsed-hint{text-align:center;padding:6px 0}
.collapsed-hint span{
  font-size:.7rem;color:rgba(255,255,255,.35);
  background:rgba(0,0,0,.25);backdrop-filter:blur(8px);
  padding:3px 10px;border-radius:10px;
}
</style>
</head>
<body>

<div class="bg-photo" id="bgPhoto"></div>

<div class="header">
  <div class="header-inner">
    <div class="header-avatar"><img src="audio/zoey-avatar.jpg" alt="知意" /></div>
    <div class="header-info">
      <div class="header-name">沈知意</div>
      <div class="header-tag">内容由 AI 生成</div>
    </div>
  </div>
</div>

<div class="scroll-wrap">
  <div class="photo-spacer"></div>
  <div class="chat-area" id="chatArea">
    <div class="loading">loading...</div>
  </div>
</div>

<div class="player-bar" id="playerBar">
  <div class="p-top">
    <div class="p-avatar"><img src="audio/zoey-avatar.jpg" alt="" /></div>
    <div class="p-info">
      <div class="t" id="nowPlaying">--</div>
      <div class="m" id="nowMeta">知意</div>
    </div>
  </div>
  <div class="prog-wrap" id="progressWrap">
    <div class="prog-bg"><div class="prog-fill" id="progressFill"></div></div>
  </div>
  <div class="time-row"><span id="timeCur">0:00</span><span id="timeTotal">0:00</span></div>
  <div class="controls">
    <button class="ctrl-btn" id="btnBack">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/><text x="12" y="16" fill="currentColor" stroke="none" font-size="8" text-anchor="middle" font-weight="bold">15</text></svg>
    </button>
    <button class="ctrl-btn play" id="btnPlay">
      <svg id="iconPlay" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="7,3 21,12 7,21"/></svg>
      <svg id="iconPause" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="5" y="3" width="4" height="18" rx="1"/><rect x="15" y="3" width="4" height="18" rx="1"/></svg>
    </button>
    <button class="ctrl-btn" id="btnFwd">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.13-9.36L23 10"/><text x="12" y="16" fill="currentColor" stroke="none" font-size="8" text-anchor="middle" font-weight="bold">30</text></svg>
    </button>
    <button class="speed-btn" id="btnSpeed">1.0x</button>
  </div>
</div>

<audio id="audio" preload="metadata"></audio>

<script>
(function(){
  var SPEEDS=[.8,1,1.2,1.5,2],AUDIO_BASE='audio/',MANIFEST_URL='audio/manifest.json',
      AVATAR='audio/zoey-avatar.jpg',
      BGS=['audio/bg-cafe-casual.jpg','audio/bg-cafe-elegant.jpg','audio/bg-cafe-confident.jpg','audio/bg-cafe-warm.jpg','audio/bg-cafe-gentle.jpg','audio/bg-cafe-chic.jpg','audio/bg-library.jpg','audio/bg-park.jpg'];

  var d=new Date(),seed=d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate(),
      shift=Math.floor(d.getHours()/6),idx=(seed+shift)%BGS.length;
  document.getElementById('bgPhoto').style.backgroundImage='url('+BGS[idx]+')';

  var audio=document.getElementById('audio'),
      chatArea=document.getElementById('chatArea'),
      playerBar=document.getElementById('playerBar'),
      nowPlaying=document.getElementById('nowPlaying'),
      nowMeta=document.getElementById('nowMeta'),
      progressFill=document.getElementById('progressFill'),
      progressWrap=document.getElementById('progressWrap'),
      timeCur=document.getElementById('timeCur'),
      timeTotal=document.getElementById('timeTotal'),
      btnPlay=document.getElementById('btnPlay'),
      iconPlay=document.getElementById('iconPlay'),
      iconPause=document.getElementById('iconPause'),
      btnBack=document.getElementById('btnBack'),
      btnFwd=document.getElementById('btnFwd'),
      btnSpeed=document.getElementById('btnSpeed');

  var manifest=[],currentIdx=-1,speedIdx=1;
  function fmt(s){if(!s||isNaN(s))return'0:00';var m=Math.floor(s/60),sec=Math.floor(s%60);return m+':'+(sec<10?'0':'')+sec}
  var catLabel={briefing:'每日简报',interview:'面试准备'};

  function fmtDate(ds){
    if(!ds)return'';var p=ds.split('-');return parseInt(p[1])+'月'+parseInt(p[2])+'日';
  }

  function init(){
    fetch(MANIFEST_URL+'?t='+Date.now()).then(function(r){return r.json()}).then(function(data){
      manifest=data;
      manifest.sort(function(a,b){
        if(a.date&&b.date){var c=a.date.localeCompare(b.date);if(c)return c}
        if(a.category==='briefing'&&b.category!=='briefing')return-1;
        if(a.category!=='briefing'&&b.category==='briefing')return 1;
        return 0;
      });
      render();
    }).catch(function(){chatArea.innerHTML='<div class="loading">暂无内容</div>'});
  }

  function render(){
    var html='',lastDate='',bars='';
    var isPlaying=currentIdx>=0&&!audio.paused;

    /* Which indices to show: current + 1 neighbor */
    var showIdx={};
    if(isPlaying){
      showIdx[currentIdx]=true;
      if(currentIdx+1<manifest.length)showIdx[currentIdx+1]=true;
      else if(currentIdx-1>=0)showIdx[currentIdx-1]=true;
    }
    /* Which dates have visible messages */
    var visDates={};
    for(var k in showIdx){if(manifest[k])visDates[manifest[k].date||'']=true}

    for(var i=0;i<8;i++)bars+='<div class="bar"></div>';

    var hiddenAbove=0,hintInserted=false;

    for(var i=0;i<manifest.length;i++){
      var a=manifest[i],ds=a.date||'',cat=a.category||'other',
          isP=i===currentIdx&&!audio.paused;
      var show=!isPlaying||showIdx[i];

      if(ds!==lastDate){
        var dVis=!isPlaying||visDates[ds];
        html+='<div class="time-divider'+(dVis?' vis':'')+'"><span>'+fmtDate(ds)+'</span></div>';
        lastDate=ds;
      }

      if(!show)hiddenAbove++;
      /* Insert collapsed hint once, just before the first visible message */
      if(show&&hiddenAbove>0&&!hintInserted){
        html+='<div class="collapsed-hint vis"><span>'+hiddenAbove+' 条消息</span></div>';
        hintInserted=true;
      }

      html+='<div class="msg'+(show?' vis':'')+'">'+
        '<div class="bubble">'+
          '<div class="audio-card" data-idx="'+i+'">'+
            '<div class="ac-header">'+
              '<button class="ac-play'+(isP?' playing':'')+'" data-idx="'+i+'">'+
                (isP?'<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="5" y="3" width="4" height="18" rx="1"/><rect x="15" y="3" width="4" height="18" rx="1"/></svg>':
                     '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="7,3 21,12 7,21"/></svg>')+
              '</button>'+
              '<div class="ac-info">'+
                '<div class="ac-title">'+a.title+'</div>'+
                '<div class="ac-meta">'+(catLabel[cat]||cat)+'</div>'+
              '</div>'+
            '</div>'+
            '<div class="ac-wave'+(isP?' active':'')+'">'+bars+'</div>'+
          '</div>'+
        '</div>'+
      '</div>';
    }

    if(isPlaying)chatArea.classList.add('playing-mode');
    else chatArea.classList.remove('playing-mode');
    chatArea.innerHTML=html;

    chatArea.querySelectorAll('.audio-card,.ac-play').forEach(function(el){
      el.onclick=function(e){
        e.stopPropagation();
        var n=parseInt(el.dataset.idx);
        if(n===currentIdx&&!audio.paused)audio.pause();else play(n);
      };
    });
  }

  function play(n){
    if(n<0||n>=manifest.length)return;
    currentIdx=n;var a=manifest[n];
    audio.src=AUDIO_BASE+a.file;audio.playbackRate=SPEEDS[speedIdx];
    audio.play().catch(function(){});
    nowPlaying.textContent=a.title;
    nowMeta.textContent=fmtDate(a.date)+' · 知意';
    playerBar.classList.add('visible');render();
    var card=chatArea.querySelector('.audio-card[data-idx="'+n+'"]');
    if(card)card.scrollIntoView({behavior:'smooth',block:'center'});
  }

  btnPlay.onclick=function(){if(!audio.src)return;if(audio.paused)audio.play().catch(function(){});else audio.pause()};
  btnBack.onclick=function(){audio.currentTime=Math.max(0,audio.currentTime-15)};
  btnFwd.onclick=function(){audio.currentTime=Math.min(audio.duration||0,audio.currentTime+30)};
  btnSpeed.onclick=function(){speedIdx=(speedIdx+1)%SPEEDS.length;audio.playbackRate=SPEEDS[speedIdx];btnSpeed.textContent=SPEEDS[speedIdx]+'x'};

  audio.addEventListener('play',function(){iconPlay.style.display='none';iconPause.style.display='';render()});
  audio.addEventListener('pause',function(){iconPlay.style.display='';iconPause.style.display='none';render()});
  audio.addEventListener('timeupdate',function(){
    if(!audio.duration)return;
    progressFill.style.width=(audio.currentTime/audio.duration*100)+'%';
    timeCur.textContent=fmt(audio.currentTime);timeTotal.textContent=fmt(audio.duration);
  });
  audio.addEventListener('ended',function(){if(currentIdx<manifest.length-1)play(currentIdx+1);else render()});

  function seek(e){
    var r=progressWrap.getBoundingClientRect(),
        x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
    audio.currentTime=Math.max(0,Math.min(1,x/r.width))*(audio.duration||0);
  }
  progressWrap.addEventListener('click',seek);
  var drag=false;
  progressWrap.addEventListener('touchstart',function(e){drag=true;seek(e)},{passive:true});
  document.addEventListener('touchmove',function(e){if(drag)seek(e)},{passive:true});
  document.addEventListener('touchend',function(){drag=false});

  if('mediaSession' in navigator){
    audio.addEventListener('play',function(){
      var a=manifest[currentIdx];if(!a)return;
      navigator.mediaSession.metadata=new MediaMetadata({title:a.title,artist:'沈知意 | Zoey',album:catLabel[a.category]||'Audio'});
    });
    navigator.mediaSession.setActionHandler('play',function(){audio.play()});
    navigator.mediaSession.setActionHandler('pause',function(){audio.pause()});
    navigator.mediaSession.setActionHandler('seekbackward',function(){audio.currentTime=Math.max(0,audio.currentTime-15)});
    navigator.mediaSession.setActionHandler('seekforward',function(){audio.currentTime+=30});
    navigator.mediaSession.setActionHandler('previoustrack',function(){if(currentIdx>0)play(currentIdx-1)});
    navigator.mediaSession.setActionHandler('nexttrack',function(){if(currentIdx<manifest.length-1)play(currentIdx+1)});
  }

  init();
})();
</script>
</body>
</html>
