<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000">
<title>ZoeyTalk</title>
<link rel="manifest" href="manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,'PingFang SC','Helvetica Neue','Microsoft YaHei',sans-serif;
  background:#000;color:#fff;
  min-height:100vh;min-height:100dvh;
  -webkit-tap-highlight-color:transparent;
  overflow-x:hidden;
}

/* Full-screen background photo */
.bg-photo{
  position:fixed;top:0;left:0;right:0;
  height:100vh;height:100dvh;
  background-size:cover;background-position:center top;
  z-index:0;
}
.bg-photo::after{
  content:'';position:absolute;bottom:0;left:0;right:0;
  height:55%;
  background:linear-gradient(to top,rgba(0,0,0,.85) 0%,rgba(0,0,0,.5) 40%,transparent 100%);
}

/* Header */
.header{
  position:fixed;top:0;left:0;right:0;z-index:200;
  padding:env(safe-area-inset-top) 0 0;
}
.header-inner{
  max-width:480px;margin:0 auto;
  display:flex;align-items:center;gap:10px;
  height:52px;padding:0 16px;
}
.header-avatar{
  width:36px;height:36px;border-radius:50%;overflow:hidden;
  border:2px solid rgba(255,255,255,.3);flex-shrink:0;
}
.header-avatar img{width:100%;height:100%;object-fit:cover}
.header-info{flex:1}
.header-name{font-size:1rem;font-weight:600;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.5)}
.header-tag{font-size:.68rem;color:rgba(255,255,255,.6)}

/* Scroll container */
.scroll-wrap{
  position:relative;z-index:1;
  min-height:100vh;min-height:100dvh;
  display:flex;flex-direction:column;
  justify-content:flex-end;
}
.photo-spacer{
  flex-shrink:0;height:48vh;pointer-events:none;
}
.chat-area{
  max-width:480px;width:100%;margin:0 auto;
  padding:0 14px calc(40px + env(safe-area-inset-bottom));
}

/* Time divider */
.time-divider{text-align:center;padding:12px 0 8px}
.time-divider span{
  display:inline-block;padding:3px 10px;border-radius:4px;
  background:rgba(0,0,0,.3);backdrop-filter:blur(8px);
  font-size:.7rem;color:rgba(255,255,255,.6);
}

/* Message bubble */
.msg{margin-bottom:10px}
.bubble{
  display:inline-block;max-width:88%;
  padding:10px 14px;
  border-radius:16px;
  background:rgba(255,255,255,.12);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,.08);
  font-size:.88rem;line-height:1.55;color:rgba(255,255,255,.92);
  word-break:break-word;
}

/* Audio card */
.audio-card{min-width:220px}
.ac-header{display:flex;align-items:center;gap:10px}
.ac-play{
  flex-shrink:0;width:38px;height:38px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.2);color:#fff;
  transition:all .15s;
}
.ac-play:active{transform:scale(.9)}
.ac-play.playing{
  background:rgba(255,255,255,.35);
  animation:glow 1.5s infinite;
}
@keyframes glow{
  0%,100%{box-shadow:0 0 8px rgba(255,255,255,.1)}
  50%{box-shadow:0 0 16px rgba(255,255,255,.3)}
}
.ac-info{flex:1;min-width:0}
.ac-title{
  font-size:.88rem;font-weight:500;color:#fff;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.ac-meta{font-size:.7rem;color:rgba(255,255,255,.5);margin-top:1px}

/* Waveform */
.ac-wave{display:flex;align-items:center;gap:2px;height:18px;margin-top:6px}
.ac-wave .bar{width:2.5px;border-radius:2px;background:rgba(255,255,255,.2);height:4px}
.ac-wave.active .bar{animation:wave .6s ease-in-out infinite alternate;background:rgba(255,255,255,.7)}
.ac-wave.active .bar:nth-child(1){animation-delay:0s}
.ac-wave.active .bar:nth-child(2){animation-delay:.08s}
.ac-wave.active .bar:nth-child(3){animation-delay:.16s}
.ac-wave.active .bar:nth-child(4){animation-delay:.12s}
.ac-wave.active .bar:nth-child(5){animation-delay:.2s}
.ac-wave.active .bar:nth-child(6){animation-delay:.04s}
.ac-wave.active .bar:nth-child(7){animation-delay:.18s}
.ac-wave.active .bar:nth-child(8){animation-delay:.1s}
@keyframes wave{0%{height:4px}100%{height:18px}}

/* Progress row — only visible on current card */
.ac-progress{
  display:flex;align-items:center;gap:8px;
  margin-top:8px;height:20px;
}
.ac-prog-bar{flex:1;height:3px;background:rgba(255,255,255,.12);border-radius:2px;position:relative;cursor:pointer;touch-action:none}
.ac-prog-fill{height:100%;background:rgba(255,255,255,.7);border-radius:2px;width:0%;transition:none}
.ac-prog-fill::after{
  content:'';position:absolute;right:-4px;top:50%;transform:translateY(-50%);
  width:8px;height:8px;background:#fff;border-radius:50%;
}
.ac-time{font-size:.62rem;color:rgba(255,255,255,.4);white-space:nowrap;min-width:66px;text-align:center}
.ac-speed{
  font-size:.62rem;font-weight:700;
  padding:2px 6px;background:rgba(255,255,255,.15);border:none;
  color:rgba(255,255,255,.6);border-radius:6px;cursor:pointer;
  white-space:nowrap;
}
.ac-speed:active{background:rgba(255,255,255,.25)}

/* Actions row */
.ac-actions{display:flex;align-items:center;gap:6px;margin-top:6px}
.ac-btn{
  font-size:.72rem;color:rgba(255,255,255,.5);
  background:none;border:none;cursor:pointer;
  padding:3px 0;display:flex;align-items:center;gap:3px;
}
.ac-btn:active{color:rgba(255,255,255,.8)}
.ac-btn svg{width:12px;height:12px}

/* Script text */
.ac-script{
  margin-top:8px;padding-top:8px;
  border-top:1px solid rgba(255,255,255,.08);
  font-size:.78rem;line-height:1.7;color:rgba(255,255,255,.7);
  max-height:280px;overflow-y:auto;
  white-space:pre-wrap;
  -webkit-overflow-scrolling:touch;
}
.ac-script::-webkit-scrollbar{width:3px}
.ac-script::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px}

/* Playing mode — collapse to show only 2 messages */
.chat-area.playing-mode .msg{display:none}
.chat-area.playing-mode .msg.vis{display:block}
.chat-area.playing-mode .time-divider{display:none}
.chat-area.playing-mode .time-divider.vis{display:block}
.collapsed-hint{text-align:center;padding:6px 0}
.collapsed-hint span{
  font-size:.7rem;color:rgba(255,255,255,.35);
  background:rgba(0,0,0,.25);backdrop-filter:blur(8px);
  padding:3px 10px;border-radius:10px;
}

.loading{text-align:center;padding:40px;color:rgba(255,255,255,.4);font-size:.85rem}
</style>
</head>
<body>

<div class="bg-photo" id="bgPhoto"></div>

<div class="header">
  <div class="header-inner">
    <div class="header-avatar"><img src="audio/zoey-avatar.jpg" alt="知意" /></div>
    <div class="header-info">
      <div class="header-name">ZoeyTalk</div>
      <div class="header-tag">内容由 AI 生成</div>
    </div>
  </div>
</div>

<div class="scroll-wrap">
  <div class="photo-spacer"></div>
  <div class="chat-area" id="chatArea">
    <div class="loading">loading...</div>
  </div>
</div>

<audio id="audio" preload="metadata"></audio>

<script>
(function(){
  var SPEEDS=[.8,1,1.2,1.5,2],AUDIO_BASE='audio/',MANIFEST_URL='audio/manifest.json',
      BGS=['audio/bg-cafe-casual.jpg','audio/bg-cafe-elegant.jpg','audio/bg-cafe-confident.jpg','audio/bg-cafe-warm.jpg','audio/bg-cafe-gentle.jpg','audio/bg-cafe-chic.jpg','audio/bg-library.jpg','audio/bg-park.jpg'];

  var d=new Date(),seed=d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate(),
      shift=Math.floor(d.getHours()/6),idx=(seed+shift)%BGS.length;
  document.getElementById('bgPhoto').style.backgroundImage='url('+BGS[idx]+')';

  var audio=document.getElementById('audio'),
      chatArea=document.getElementById('chatArea');

  var manifest=[],currentIdx=-1,speedIdx=1,expandedScripts={};

  function fmt(s){if(!s||isNaN(s))return'0:00';var m=Math.floor(s/60),sec=Math.floor(s%60);return m+':'+(sec<10?'0':'')+sec}
  var catLabel={briefing:'每日简报',interview:'面试准备'};

  function fmtDate(ds){
    if(!ds)return'';var p=ds.split('-');return parseInt(p[1])+'月'+parseInt(p[2])+'日';
  }

  function init(){
    fetch(MANIFEST_URL+'?t='+Date.now()).then(function(r){return r.json()}).then(function(data){
      manifest=data;
      manifest.sort(function(a,b){
        if(a.date&&b.date){var c=a.date.localeCompare(b.date);if(c)return c}
        if(a.category==='briefing'&&b.category!=='briefing')return-1;
        if(a.category!=='briefing'&&b.category==='briefing')return 1;
        return 0;
      });
      render();
    }).catch(function(){chatArea.innerHTML='<div class="loading">暂无内容</div>'});
  }

  function render(){
    var html='',lastDate='',bars='';
    var isPlaying=currentIdx>=0&&!audio.paused;

    /* Playing mode: show current + 1 neighbor */
    var showIdx={};
    if(isPlaying){
      showIdx[currentIdx]=true;
      if(currentIdx+1<manifest.length)showIdx[currentIdx+1]=true;
      else if(currentIdx-1>=0)showIdx[currentIdx-1]=true;
    }
    var visDates={};
    for(var k in showIdx){if(manifest[k])visDates[manifest[k].date||'']=true}

    for(var i=0;i<8;i++)bars+='<div class="bar"></div>';

    var hiddenAbove=0,hintInserted=false;

    for(var i=0;i<manifest.length;i++){
      var a=manifest[i],ds=a.date||'',cat=a.category||'other',
          isP=i===currentIdx&&!audio.paused,
          isCur=i===currentIdx;
      var show=!isPlaying||showIdx[i];
      var hasScript=!!a.script;
      var scriptOpen=!!expandedScripts[i];

      if(ds!==lastDate){
        var dVis=!isPlaying||visDates[ds];
        html+='<div class="time-divider'+(dVis?' vis':'')+'"><span>'+fmtDate(ds)+'</span></div>';
        lastDate=ds;
      }

      if(!show)hiddenAbove++;
      if(show&&hiddenAbove>0&&!hintInserted){
        html+='<div class="collapsed-hint vis"><span>'+hiddenAbove+' 条消息</span></div>';
        hintInserted=true;
      }

      /* Build card HTML */
      var card='<div class="audio-card" data-idx="'+i+'">'+
        '<div class="ac-header">'+
          '<button class="ac-play'+(isP?' playing':'')+'" data-idx="'+i+'">'+
            (isP?'<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="5" y="3" width="4" height="18" rx="1"/><rect x="15" y="3" width="4" height="18" rx="1"/></svg>':
                 '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="7,3 21,12 7,21"/></svg>')+
          '</button>'+
          '<div class="ac-info">'+
            '<div class="ac-title">'+a.title+'</div>'+
            '<div class="ac-meta">'+(catLabel[cat]||cat)+'</div>'+
          '</div>'+
        '</div>';

      /* Waveform */
      card+='<div class="ac-wave'+(isP?' active':'')+'">'+bars+'</div>';

      /* Progress row — only for current item */
      if(isCur){
        card+='<div class="ac-progress">'+
          '<div class="ac-prog-bar" data-idx="'+i+'"><div class="ac-prog-fill" id="progFill"></div></div>'+
          '<span class="ac-time"><span id="tCur">0:00</span> / <span id="tTot">0:00</span></span>'+
          '<button class="ac-speed" id="speedBtn">'+SPEEDS[speedIdx]+'x</button>'+
        '</div>';
      }

      /* Actions: 查看原文 */
      if(hasScript){
        card+='<div class="ac-actions">'+
          '<button class="ac-btn script-toggle" data-idx="'+i+'">'+
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>'+
            (scriptOpen?'收起原文':'查看原文')+
          '</button>'+
        '</div>';
      }

      /* Script text (expanded) */
      if(hasScript&&scriptOpen){
        card+='<div class="ac-script">'+escHtml(a.script)+'</div>';
      }

      card+='</div>';

      html+='<div class="msg'+(show?' vis':'')+'">'+
        '<div class="bubble">'+card+'</div>'+
      '</div>';
    }

    if(isPlaying)chatArea.classList.add('playing-mode');
    else chatArea.classList.remove('playing-mode');
    chatArea.innerHTML=html;
    bindEvents();
  }

  function escHtml(s){
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function bindEvents(){
    /* Play/pause buttons */
    chatArea.querySelectorAll('.ac-play').forEach(function(el){
      el.onclick=function(e){
        e.stopPropagation();
        var n=parseInt(el.dataset.idx);
        if(n===currentIdx&&!audio.paused)audio.pause();else play(n);
      };
    });

    /* Script toggle */
    chatArea.querySelectorAll('.script-toggle').forEach(function(el){
      el.onclick=function(e){
        e.stopPropagation();
        var n=parseInt(el.dataset.idx);
        expandedScripts[n]=!expandedScripts[n];
        render();
        /* Scroll to this card */
        setTimeout(function(){
          var card=chatArea.querySelector('.audio-card[data-idx="'+n+'"]');
          if(card)card.scrollIntoView({behavior:'smooth',block:'center'});
        },50);
      };
    });

    /* Progress bar seek */
    var progBar=chatArea.querySelector('.ac-prog-bar');
    if(progBar){
      function seekFromBar(e){
        var r=progBar.getBoundingClientRect(),
            x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
        audio.currentTime=Math.max(0,Math.min(1,x/r.width))*(audio.duration||0);
      }
      progBar.onclick=seekFromBar;
      var drag=false;
      progBar.addEventListener('touchstart',function(e){drag=true;seekFromBar(e)},{passive:true});
      document.addEventListener('touchmove',function(e){if(drag)seekFromBar(e)},{passive:true});
      document.addEventListener('touchend',function(){drag=false});
    }

    /* Speed button */
    var speedBtn=document.getElementById('speedBtn');
    if(speedBtn){
      speedBtn.onclick=function(e){
        e.stopPropagation();
        speedIdx=(speedIdx+1)%SPEEDS.length;
        audio.playbackRate=SPEEDS[speedIdx];
        speedBtn.textContent=SPEEDS[speedIdx]+'x';
      };
    }
  }

  function play(n){
    if(n<0||n>=manifest.length)return;
    currentIdx=n;var a=manifest[n];
    audio.src=AUDIO_BASE+a.file;audio.playbackRate=SPEEDS[speedIdx];
    audio.play().catch(function(){});
    render();
    setTimeout(function(){
      var card=chatArea.querySelector('.audio-card[data-idx="'+n+'"]');
      if(card)card.scrollIntoView({behavior:'smooth',block:'center'});
    },50);
  }

  audio.addEventListener('play',function(){render()});
  audio.addEventListener('pause',function(){render()});
  audio.addEventListener('timeupdate',function(){
    if(!audio.duration)return;
    var fill=document.getElementById('progFill');
    var tCur=document.getElementById('tCur');
    var tTot=document.getElementById('tTot');
    if(fill)fill.style.width=(audio.currentTime/audio.duration*100)+'%';
    if(tCur)tCur.textContent=fmt(audio.currentTime);
    if(tTot)tTot.textContent=fmt(audio.duration);
  });
  audio.addEventListener('ended',function(){if(currentIdx<manifest.length-1)play(currentIdx+1);else{currentIdx=-1;render()}});

  /* MediaSession for lock screen controls */
  if('mediaSession' in navigator){
    audio.addEventListener('play',function(){
      var a=manifest[currentIdx];if(!a)return;
      navigator.mediaSession.metadata=new MediaMetadata({title:a.title,artist:'ZoeyTalk',album:catLabel[a.category]||'Audio'});
    });
    navigator.mediaSession.setActionHandler('play',function(){audio.play()});
    navigator.mediaSession.setActionHandler('pause',function(){audio.pause()});
    navigator.mediaSession.setActionHandler('seekbackward',function(){audio.currentTime=Math.max(0,audio.currentTime-15)});
    navigator.mediaSession.setActionHandler('seekforward',function(){audio.currentTime+=30});
    navigator.mediaSession.setActionHandler('previoustrack',function(){if(currentIdx>0)play(currentIdx-1)});
    navigator.mediaSession.setActionHandler('nexttrack',function(){if(currentIdx<manifest.length-1)play(currentIdx+1)});
  }

  init();
})();
</script>
</body>
</html>
