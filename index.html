<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>Warren Audio Briefings</title>
<link rel="manifest" href="manifest.json">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#0f172a;--surface:#1e293b;--surface2:#334155;
    --text:#f8fafc;--text2:#94a3b8;--accent:#3b82f6;--accent2:#60a5fa;
    --success:#22c55e;--radius:16px;
  }
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:var(--bg);color:var(--text);
    min-height:100vh;min-height:100dvh;
    -webkit-tap-highlight-color:transparent;
    overflow-x:hidden;
  }
  .container{max-width:480px;margin:0 auto;padding:16px 16px 120px}
  header{text-align:center;padding:24px 0 16px}
  header h1{font-size:1.5rem;font-weight:700;letter-spacing:-.02em}
  header p{color:var(--text2);font-size:.85rem;margin-top:4px}
  .tabs{display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px}
  .tabs button{
    flex-shrink:0;padding:8px 16px;border-radius:20px;border:none;
    background:var(--surface);color:var(--text2);font-size:.85rem;cursor:pointer;
    transition:all .2s;
  }
  .tabs button.active{background:var(--accent);color:#fff}
  .card{
    background:var(--surface);border-radius:var(--radius);padding:16px;
    margin-bottom:12px;cursor:pointer;transition:all .15s;
    border:2px solid transparent;position:relative;
  }
  .card:active{transform:scale(.98)}
  .card.playing{border-color:var(--accent)}
  .card .title{font-size:1rem;font-weight:600;margin-bottom:4px;line-height:1.4}
  .card .meta{color:var(--text2);font-size:.8rem;display:flex;gap:12px;align-items:center}
  .card .meta .dur{display:flex;align-items:center;gap:4px}
  .card .badge{
    display:inline-block;padding:2px 8px;border-radius:10px;font-size:.7rem;
    font-weight:600;background:var(--accent);color:#fff;margin-left:8px;
  }
  .card .badge.interview{background:#8b5cf6}
  .card .badge.briefing{background:var(--success)}

  /* Player bar */
  .player-bar{
    position:fixed;bottom:0;left:0;right:0;
    background:var(--surface);border-top:1px solid var(--surface2);
    padding:12px 16px calc(12px + env(safe-area-inset-bottom));
    transform:translateY(100%);transition:transform .3s ease;
    z-index:100;backdrop-filter:blur(20px);
    -webkit-backdrop-filter:blur(20px);
    background:rgba(30,41,59,.95);
  }
  .player-bar.visible{transform:translateY(0)}
  .player-bar .now-playing{
    font-size:.8rem;color:var(--text2);white-space:nowrap;
    overflow:hidden;text-overflow:ellipsis;margin-bottom:8px;
    text-align:center;
  }
  .progress-wrap{
    width:100%;height:28px;display:flex;align-items:center;
    cursor:pointer;touch-action:none;margin-bottom:8px;
  }
  .progress-bg{
    width:100%;height:4px;background:var(--surface2);border-radius:2px;
    position:relative;overflow:visible;
  }
  .progress-fill{
    height:100%;background:var(--accent);border-radius:2px;
    width:0%;position:relative;transition:none;
  }
  .progress-fill::after{
    content:'';position:absolute;right:-8px;top:50%;transform:translateY(-50%);
    width:16px;height:16px;background:var(--accent2);border-radius:50%;
    box-shadow:0 0 8px rgba(59,130,246,.5);
  }
  .time-row{display:flex;justify-content:space-between;font-size:.75rem;color:var(--text2);margin-bottom:10px}
  .controls{display:flex;align-items:center;justify-content:center;gap:20px}
  .ctrl-btn{
    background:none;border:none;color:var(--text);cursor:pointer;
    width:48px;height:48px;display:flex;align-items:center;justify-content:center;
    border-radius:50%;transition:background .15s;font-size:1.2rem;
  }
  .ctrl-btn:active{background:var(--surface2)}
  .ctrl-btn.play{
    width:64px;height:64px;background:var(--accent);border-radius:50%;font-size:1.5rem;
  }
  .ctrl-btn.play:active{background:var(--accent2)}
  .speed-btn{
    font-size:.8rem;font-weight:700;min-width:48px;
    padding:6px 10px;background:var(--surface2);border:none;
    color:var(--text);border-radius:12px;cursor:pointer;
    text-align:center;
  }
  .speed-btn:active{background:var(--accent)}

  /* Empty state */
  .empty{text-align:center;padding:60px 20px;color:var(--text2)}
  .empty svg{width:64px;height:64px;opacity:.3;margin-bottom:16px}

  /* Loading */
  .loading{text-align:center;padding:40px;color:var(--text2)}
  @keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
  .loading span{animation:pulse 1.5s infinite}

  /* Scroll to hide address bar */
  @media(max-width:480px){.container{padding:12px 12px 120px}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Warren Audio Briefings</h1>
    <p id="subtitle">Loading...</p>
  </header>
  <div class="tabs" id="tabs"></div>
  <div id="list"><div class="loading"><span>Loading audio list...</span></div></div>
</div>

<div class="player-bar" id="playerBar">
  <div class="now-playing" id="nowPlaying">--</div>
  <div class="progress-wrap" id="progressWrap">
    <div class="progress-bg">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>
  <div class="time-row">
    <span id="timeCur">0:00</span>
    <span id="timeTotal">0:00</span>
  </div>
  <div class="controls">
    <button class="ctrl-btn" id="btnBack" title="Back 15s">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/><text x="12" y="16" fill="currentColor" stroke="none" font-size="8" text-anchor="middle" font-weight="bold">15</text></svg>
    </button>
    <button class="ctrl-btn play" id="btnPlay" title="Play">
      <svg id="iconPlay" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><polygon points="6,3 20,12 6,21"/></svg>
      <svg id="iconPause" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="5" y="3" width="4" height="18"/><rect x="15" y="3" width="4" height="18"/></svg>
    </button>
    <button class="ctrl-btn" id="btnFwd" title="Forward 30s">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.13-9.36L23 10"/><text x="12" y="16" fill="currentColor" stroke="none" font-size="8" text-anchor="middle" font-weight="bold">30</text></svg>
    </button>
    <button class="speed-btn" id="btnSpeed">1.0x</button>
  </div>
</div>

<audio id="audio" preload="metadata"></audio>

<script>
(function(){
  // --- Config ---
  const SPEEDS = [0.8, 1.0, 1.2, 1.5, 2.0];
  const AUDIO_BASE = 'audio/';
  const MANIFEST_URL = 'audio/manifest.json';

  // --- DOM refs ---
  const audio = document.getElementById('audio');
  const list = document.getElementById('list');
  const tabs = document.getElementById('tabs');
  const subtitle = document.getElementById('subtitle');
  const playerBar = document.getElementById('playerBar');
  const nowPlaying = document.getElementById('nowPlaying');
  const progressFill = document.getElementById('progressFill');
  const progressWrap = document.getElementById('progressWrap');
  const timeCur = document.getElementById('timeCur');
  const timeTotal = document.getElementById('timeTotal');
  const btnPlay = document.getElementById('btnPlay');
  const iconPlay = document.getElementById('iconPlay');
  const iconPause = document.getElementById('iconPause');
  const btnBack = document.getElementById('btnBack');
  const btnFwd = document.getElementById('btnFwd');
  const btnSpeed = document.getElementById('btnSpeed');

  let manifest = [];
  let categories = [];
  let currentCat = 'all';
  let currentIdx = -1;
  let speedIdx = 1; // 1.0x default

  // --- Helpers ---
  function fmt(s){
    if(!s||isNaN(s))return '0:00';
    const m=Math.floor(s/60), sec=Math.floor(s%60);
    return m+':'+(sec<10?'0':'')+sec;
  }

  // --- Fetch manifest ---
  async function init(){
    try{
      const r = await fetch(MANIFEST_URL);
      if(!r.ok) throw new Error('No manifest');
      manifest = await r.json();
    }catch(e){
      // Fallback: scan known audio files
      manifest = [];
    }
    if(!manifest.length){
      list.innerHTML='<div class="empty"><p>No audio files yet.</p><p style="margin-top:8px;font-size:.8rem">Add MP3 files to audio/ and update manifest.json</p></div>';
      subtitle.textContent = 'No briefings available';
      return;
    }
    // Extract categories
    const catSet = new Set();
    manifest.forEach(a => (a.category||'Other') && catSet.add(a.category||'Other'));
    categories = ['all', ...catSet];
    renderTabs();
    renderList();
    subtitle.textContent = manifest.length + ' audio files';
  }

  function renderTabs(){
    const labels = {all:'All', briefing:'Briefings', interview:'Interview Prep'};
    tabs.innerHTML = categories.map(c =>
      `<button class="${c===currentCat?'active':''}" data-cat="${c}">${labels[c]||c}</button>`
    ).join('');
    tabs.querySelectorAll('button').forEach(b => {
      b.onclick = () => {
        currentCat = b.dataset.cat;
        renderTabs();
        renderList();
      };
    });
  }

  function renderList(){
    const items = currentCat==='all' ? manifest :
      manifest.filter(a => (a.category||'Other')===currentCat);
    if(!items.length){
      list.innerHTML='<div class="empty"><p>No items in this category</p></div>';
      return;
    }
    list.innerHTML = items.map((a, i) => {
      const idx = manifest.indexOf(a);
      const cat = a.category||'Other';
      const badgeClass = cat==='interview'?'interview': cat==='briefing'?'briefing':'';
      return `<div class="card ${idx===currentIdx?'playing':''}" data-idx="${idx}">
        <div class="title">${a.title}</div>
        <div class="meta">
          <span class="dur"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>${a.duration||'--'}</span>
          <span>${a.date||''}</span>
          <span class="badge ${badgeClass}">${cat}</span>
        </div>
      </div>`;
    }).join('');
    list.querySelectorAll('.card').forEach(card => {
      card.onclick = () => play(parseInt(card.dataset.idx));
    });
  }

  function play(idx){
    if(idx<0||idx>=manifest.length) return;
    currentIdx = idx;
    const a = manifest[idx];
    audio.src = AUDIO_BASE + a.file;
    audio.playbackRate = SPEEDS[speedIdx];
    audio.play().catch(()=>{});
    nowPlaying.textContent = a.title;
    playerBar.classList.add('visible');
    renderList();
  }

  // --- Player controls ---
  btnPlay.onclick = () => {
    if(!audio.src) return;
    if(audio.paused) audio.play().catch(()=>{});
    else audio.pause();
  };
  btnBack.onclick = () => { audio.currentTime = Math.max(0, audio.currentTime - 15); };
  btnFwd.onclick = () => { audio.currentTime = Math.min(audio.duration||0, audio.currentTime + 30); };
  btnSpeed.onclick = () => {
    speedIdx = (speedIdx + 1) % SPEEDS.length;
    audio.playbackRate = SPEEDS[speedIdx];
    btnSpeed.textContent = SPEEDS[speedIdx] + 'x';
  };

  audio.addEventListener('play', () => { iconPlay.style.display='none'; iconPause.style.display=''; });
  audio.addEventListener('pause', () => { iconPlay.style.display=''; iconPause.style.display='none'; });
  audio.addEventListener('timeupdate', () => {
    if(!audio.duration) return;
    const pct = (audio.currentTime / audio.duration) * 100;
    progressFill.style.width = pct + '%';
    timeCur.textContent = fmt(audio.currentTime);
    timeTotal.textContent = fmt(audio.duration);
  });
  audio.addEventListener('ended', () => {
    // Auto-play next
    if(currentIdx < manifest.length - 1) play(currentIdx + 1);
  });

  // --- Progress bar seek ---
  function seekFromEvent(e){
    const rect = progressWrap.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const pct = Math.max(0, Math.min(1, x / rect.width));
    audio.currentTime = pct * (audio.duration || 0);
  }
  progressWrap.addEventListener('click', seekFromEvent);
  let dragging = false;
  progressWrap.addEventListener('touchstart', (e) => { dragging = true; seekFromEvent(e); }, {passive:true});
  document.addEventListener('touchmove', (e) => { if(dragging) seekFromEvent(e); }, {passive:true});
  document.addEventListener('touchend', () => { dragging = false; });

  // --- Media session API for lock screen controls ---
  if('mediaSession' in navigator){
    audio.addEventListener('play', () => {
      const a = manifest[currentIdx];
      if(!a) return;
      navigator.mediaSession.metadata = new MediaMetadata({
        title: a.title,
        artist: 'Warren Audio Briefings',
        album: a.category || 'Briefing',
      });
    });
    navigator.mediaSession.setActionHandler('play', () => audio.play());
    navigator.mediaSession.setActionHandler('pause', () => audio.pause());
    navigator.mediaSession.setActionHandler('seekbackward', () => { audio.currentTime = Math.max(0, audio.currentTime - 15); });
    navigator.mediaSession.setActionHandler('seekforward', () => { audio.currentTime += 30; });
    navigator.mediaSession.setActionHandler('previoustrack', () => { if(currentIdx>0) play(currentIdx-1); });
    navigator.mediaSession.setActionHandler('nexttrack', () => { if(currentIdx<manifest.length-1) play(currentIdx+1); });
  }

  // --- Init ---
  init();
})();
</script>
</body>
</html>
